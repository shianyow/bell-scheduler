<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dhamma Gong</title>
  <style>
    .play-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 30vh;
      background-color: #707070;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      color: white;
      font-size: 5vh;
      font-weight: bold;
      margin-bottom: 10px;
    }



    .play-button:hover {
      background-color: #212121;
    }

    .play-button.flash {
      animation: flash-bg 3s ease-in-out infinite;
    }

    @keyframes flash-bg {
      0% {
        background-color: #707070;
      }

      50% {
        background-color: #212121;
      }

      100% {
        background-color: #707070;
      }
    }

    .play-icon {
      width: 0;
      height: 0;
      border-top: 5vh solid transparent;
      border-bottom: 5vh solid transparent;
      border-left: 8vh solid white;
    }

    .play-text {
      flex-grow: 1;
    }

    .date-block {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }

    .date-block h3 {
      margin: 0;
      display: flex;
      justify-content: space-between;
    }

    .buttons {
      margin-top: 10px;
    }

    .buttons button {
      margin-right: 5px;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .control-panel {
      margin-bottom: 20px;
    }

    .btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn:hover {
      background-color: #218838;
    }

    .btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .status {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
    }

    .status.loading {
      background-color: #d1ecf1;
      color: #0c5460;
    }

    .status.success {
      background-color: #d4edda;
      color: #155724;
    }

    .status.error {
      background-color: #f8d7da;
      color: #721c24;
    }

    .card {
      background-color: #f8f9fa;
      padding: 15px;
      margin-bottom: 10px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
    }

    .schedule-item {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .schedule-item:last-child {
      border-bottom: none;
    }

    .type {
      background-color: #007bff;
      color: white;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 12px;
    }

    .pattern-card {
      background-color: white;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .pattern-title {
      font-weight: bold;
      margin-bottom: 8px;
    }

    .bell-item {
      padding: 5px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .bell-item:last-child {
      border-bottom: none;
    }

    .hidden {
      display: none;
    }
  </style>
  <script>
    // Debug log å‡½å¼ï¼ˆæ”¾åˆ°æ‰€æœ‰ JS ä¹‹å‰ï¼‰
    function debugLog(msg) {
      const logDiv = document.getElementById('debug-log');
      const now = new Date().toLocaleTimeString();
      if (typeof msg !== 'string') msg = JSON.stringify(msg);
      if (logDiv) {
        logDiv.innerHTML += `<div>[${now}] ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }
      console.log('[DEBUG]', msg);
    }
  </script>
</head>

<body>
  <button class="play-button" onclick="playAlarm()">
    <div class="play-text">é»æ­¤æ‰‹å‹•æ•²é˜<br />â–¶ï¸</div>
  </button>

  <div class="container">
    <div class="control-panel">
      <button id="keepaliveBtn" class="btn hidden">ğŸ’“ Check</button>
      <button id="loadBtn" class="btn hidden">ğŸ“¥ Load</button>
    </div>
    <div id="audio-error" class="status error hidden"></div>
    <div id="status" class="status hidden"></div>
    <div id="audio-unlock" class="status info">
      è«‹é»æ“Šç•«é¢ä»¥å•Ÿç”¨é˜è²ğŸ”“
    </div>

    <div id="bell-log" style="max-height:120px;overflow:auto;background:#f6f6f6;border:1px solid #ccc;padding:8px;margin-bottom:8px;font-size:14px;"></div>

    <!-- Debug Log å€å¡Šï¼Œç§»åˆ°è¡Œç¨‹è¡¨å‰é¢ -->
    <style>
      .audio-test-tools {
        background: #292929;
        border-radius: 8px;
        border: 1.5px solid #444;
        padding: 14px 18px 10px 12px;
        margin-bottom: 16px;
        max-width: 100%;
        box-sizing: border-box;
      }
      .audio-test-tools legend {
        color: #0f0;
        font-size: 14px;
        font-weight: bold;
        letter-spacing: 1px;
        margin-bottom: 4px;
      }
      .audio-test-btns {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 10px;
        margin-top: 2px;
      }
      .audio-test-btns button {
        background: #232323;
        color: #0f0;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 6px 14px;
        font-size: 13px;
        margin: 0;
        cursor: pointer;
        transition: background 0.18s, color 0.18s, box-shadow 0.18s;
      }
      .audio-test-btns button:hover {
        background: #0f0;
        color: #222;
        box-shadow: 0 0 0 2px #0f0 inset;
      }
    </style>
    <div class="audio-test-tools">
      <fieldset style="border:none;padding:0;margin:0;min-width:0;">
        <legend>éŸ³è¨Šæ¸¬è©¦å·¥å…·</legend>
        <div class="audio-test-btns">
          <button onclick="alarmSound.muted=true; debugLog('alarmSound.muted = true');">muted = true</button>
          <button onclick="alarmSound.muted=false; debugLog('alarmSound.muted = false');">muted = false</button>
          <button onclick="alarmSound.pause(); debugLog('alarmSound.pause()');">pause()</button>
          <button onclick="alarmSound.play().then(()=>debugLog('alarmSound.play() resolved')).catch(e=>debugLog('alarmSound.play() error: '+e)); debugLog('alarmSound.play() called');">play()</button>
          <button onclick="debugLog('currentTime: ' + alarmSound.currentTime);">print currentTime</button>
          <button onclick="debugLog('isPlaying: ' + (!alarmSound.paused));">print isPlaying</button>
          <button onclick="alarmSound.currentTime=0; debugLog('alarmSound.currentTime = 0');">currentTime = 0</button>
          <button onclick="playSingleAlarm(1,1); debugLog('PlaySingleAlarm()');">PlaySingleAlarm()</button>
          <button onclick="stopAlarm(); debugLog('stopAlarm()');">stopAlarm()</button>
        </div>
      </fieldset>
    </div>
    <div id="debug-log" style="background:#222;color:#0f0;font-size:12px;max-height:200px;overflow:auto;padding:8px;margin-bottom:12px;border-radius:6px;"></div>
    <div id="date-list"></div>

  </div>

  <!-- <audio id="alarm-sound" src="https://discourses.dhamma.org/oml/recordings/uuid/b9ddfddd-163d-484e-9588-cb34ab524dc2.mp3" preload="auto"></audio> -->
  <audio id="alarm-sound" type="audio/mp3" preload="auto">
    <source src="">
  </audio>

  <script>
    // Load bell sound 
    <?!= include('belljs') ?>

    const alarmSound = document.getElementById('alarm-sound');
    let source = alarmSound.querySelector('source');
    if (!source) {
      source = document.createElement('source');
      alarmSound.appendChild(source);
    }
    source.src = BELL_BASE64;
    alarmSound.load();

    alarmSound.muted = false;
    alarmSound.volume = 1.0;

    // Unlock audio
    const audioUnlockDiv = document.getElementById('audio-unlock');
    let audioUnlocked = false;

    function showAudioUnlockMsg(msg) {
      audioUnlockDiv.textContent = msg;
      audioUnlockDiv.classList.remove('hidden');
    }

    function hideAudioUnlockMsg() {
      audioUnlockDiv.classList.add('hidden');
    }

    function unlockAudio() {
      if (audioUnlocked) return;
      const alarmSound = document.getElementById('alarm-sound');
      alarmSound.muted = true;
      alarmSound.play()
        .then(() => {
          alarmSound.pause();
          alarmSound.currentTime = 0;
          alarmSound.muted = false;
          audioUnlocked = true;
          showAudioUnlockMsg('éŸ³è¨Šå·²è§£é–ï¼ğŸ”Š');
          setTimeout(hideAudioUnlockMsg, 1500);
        })
        .catch(() => {
          showAudioUnlockMsg('è«‹é»æ“Šç•«é¢ä»¥å•Ÿç”¨é˜è²ğŸ”“');
        });
    }

    window.addEventListener('touchstart', unlockAudio, { once: true });
    window.addEventListener('click', unlockAudio, { once: true });
    showAudioUnlockMsg('è«‹é»æ“Šç•«é¢ä»¥å•Ÿç”¨é˜è²ğŸ”“');
    // ===============================

    const dateList = document.getElementById('date-list');
    let alarms = []; // å­˜æ”¾æ‰€æœ‰é¬§é˜è³‡æ–™
    let bellConfig = {}; // BellType å°æ‡‰é‡è¤‡æ¬¡æ•¸çš„è¨­å®š
    let isAlarmPlaying = false; // æ˜¯å¦æ­£åœ¨æ’­æ”¾é˜è²
    let pendingNextTimeout = null; // ä¸‹ä¸€è²çš„ timeout id

    // æ–°å¢é¬§é˜
    function syncAlarm(data) {
      // è®€å– BellConfig (BellType -> Repeat)
      if (Array.isArray(data.BellConfig)) {
        bellConfig = data.BellConfig.reduce((acc, row) => {
          const key = row.bellType ?? row.BellType ?? row.type;
          const repeat = row.repeat ?? row.Repeat ?? row.count;
          if (key != null) acc[key] = repeat || 1;
          return acc;
        }, {});
      } else {
        bellConfig = { ...data.BellConfig };
      }


      alarms = [];
      data.CourseSchedule.forEach(course => {
        const courseDayCount = data.CourseTypes[course.courseType].length
        const dates = generateDateArray(course.startDate, courseDayCount);

        dates.forEach((date, index) => {
          const patternId = data.CourseTypes[course.courseType][index].dailyPattern
          const items = data.DailyPatterns[patternId];
          // ç¢ºèªæ˜¯å¦å·²æœ‰è©²æ—¥æœŸï¼Œè‹¥æœ‰å‰‡åˆä½µæ™‚é–“
          const existingAlarm = alarms.find(alarm => alarm.date === date);
          if (existingAlarm) {
            items.forEach(({ time, bellType }) => {
              existingAlarm.times = Array.from(new Set([...existingAlarm.times, time])).sort();
              existingAlarm.bellTypes[time] = bellType;
            });
          } else {
            const timesWithType = items.reduce((acc, it) => {
              acc.times.push(it.time);
              acc.bellTypes[it.time] = it.bellType;
              return acc;
            }, { times: [], bellTypes: {} });
            alarms.push({ date, times: Array.from(new Set(timesWithType.times)).sort(), bellTypes: timesWithType.bellTypes });
          }
        })

      })

      deletePastAlarms();
      sortAlarms();
      renderAlarms();
    }

    function generateDateArray(startDateStr, days) {
      const result = [];
      const startDate = new Date(startDateStr);

      for (let i = 0; i < days; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);

        // æ ¼å¼åŒ–æˆ YYYY-MM-DD
        const formatted = date.toISOString().split('T')[0];
        result.push(formatted);
      }

      return result;
    }



    function showAudioError(msg) {
      const errDiv = document.getElementById('audio-error');
      errDiv.textContent = msg;
      errDiv.classList.remove('hidden');
    }
    function hideAudioError() {
      const errDiv = document.getElementById('audio-error');
      errDiv.textContent = '';
      errDiv.classList.add('hidden');
    }
    // ä¾æ—¥æœŸå‡å†ªæ’åˆ—
    function sortAlarms() {
      alarms.sort((a, b) => new Date(a.date) - new Date(b.date));

      // æ¯å€‹æ—¥æœŸå…§çš„æ™‚é–“ä¹Ÿå‡å†ªæ’åˆ—
      alarms.forEach(alarm => {
        alarm.times.sort((a, b) => {
          const [ha, ma] = a.split(':').map(Number);
          const [hb, mb] = b.split(':').map(Number);
          return ha !== hb ? ha - hb : ma - mb;
        });
      });
    }

    // æ¸²æŸ“é¬§é˜åˆ—è¡¨
    function renderAlarms() {
      dateList.innerHTML = '';

      alarms
        .forEach((alarm, index) => {
          const block = document.createElement('div');
          block.className = 'date-block';

          block.innerHTML = `
                <h3>${alarm.date}
                </h3>
                <p>ğŸ”” ${alarm.times.join(', ')}</p>
            `;
          dateList.appendChild(block);
        });
    }

    function runEveryMinuteAtZeroSecond() {
      const now = new Date();
      const next = new Date(now);

      next.setSeconds(0);
      next.setMilliseconds(0);
      next.setMinutes(now.getMinutes() + 1); // ä¸‹ä¸€åˆ†é˜çš„ 0 ç§’

      const delay = next - now; // å‰©é¤˜æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰

      debugLog('runEveryMinuteAtZeroSecond: scheduling next minute task, delay=' + delay);
      setTimeout(() => {
        const hh = String(next.getHours()).padStart(2, '0');
        const mm = String(next.getMinutes()).padStart(2, '0');
        const currentTime = `${hh}:${mm}`;

        debugLog('æ¯åˆ†é˜çš„ç¬¬ 0 ç§’åŸ·è¡Œä»»å‹™: ' + currentTime);
        if (alarms && alarms.length > 0 && alarms[0].date === getTodayDateFormatted() && alarms[0].times.includes(currentTime)) {
          const bellType = alarms[0].bellTypes[currentTime] || 1;
          const repeatTimes = bellConfig[bellType] || 1;
          debugLog(`è‡ªå‹•æ’­æ”¾é˜è²: type=${bellType}, repeat=${repeatTimes}`);
          playAlarmSequence(repeatTimes, 'è‡ªå‹•');
        }
        // åšå®Œå¾Œå†å®‰æ’ä¸‹ä¸€æ¬¡
        runEveryMinuteAtZeroSecond();
      }, delay);
    }

    runEveryMinuteAtZeroSecond();

    function scheduleMidnightTask() {
      const now = new Date();
      const nextMidnight = new Date();

      nextMidnight.setDate(now.getDate() + 1); // æ˜å¤©
      nextMidnight.setHours(0, 0, 0, 0); // è¨­ç‚º 00:00:00.000

      const timeUntilMidnight = nextMidnight - now;

      setTimeout(() => {
        // âœ… åœ¨ 0:00 åŸ·è¡Œä½ çš„ä»»å‹™
        console.log("ğŸ•› æ¯æ—¥åˆå¤œä»»å‹™åŸ·è¡Œï¼");
        deletePastAlarms();

        // ç„¶å¾Œå†æ¬¡æ’ç¨‹æ˜å¤©çš„ 0:00
        scheduleMidnightTask();
      }, timeUntilMidnight);
    }

    scheduleMidnightTask();

    // æ’­æ”¾é˜è²ç´€éŒ„
    function logBellPlay(type, times) {
      const logDiv = document.getElementById('bell-log');
      if (!logDiv) return;
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, '0');
      const mm = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');
      const msg = `[${hh}:${mm}:${ss}] ${type} æ’­æ”¾é˜è² x${times}`;
      // æ’å…¥æœ€ä¸Šæ–¹
      logDiv.innerHTML = `<div>${msg}</div>` + logDiv.innerHTML;
      // æœ€å¤šåªä¿ç•™ 20 ç­†
      const logs = logDiv.querySelectorAll('div');
      if (logs.length > 20) {
        for(let i=20;i<logs.length;i++) logs[i].remove();
      }
    }

    // æ•²é˜æµç¨‹ï¼ˆæ‰‹å‹•/è‡ªå‹•å…±ç”¨ï¼‰
    function playAlarmSequence(times = 1, triggerType = 'è‡ªå‹•') {
      debugLog(`playAlarmSequence called: times=${times}, triggerType=${triggerType}, isAlarmPlaying=${isAlarmPlaying}`);
      // stopAlarm(); // ä¿éšªï¼šå…ˆç¢ºä¿ç‹€æ…‹ä¹¾æ·¨
      if (times < 1) return;
      isAlarmPlaying = true;
      playVisualAlarm(true);
      updatePlayButton(true);
      let count = 0;
      const gapMs = 300; // æ¯è²ä¹‹é–“çš„é¡å¤–åœé “ (æ¯«ç§’)
      const bellDuration = 16; // ç§’

      function playNext() {
        debugLog(`playNext: count=${count}, times=${times}`);
        if (!isAlarmPlaying) {
          debugLog('playNext aborted: isAlarmPlaying is false');
          return;
        }
        if (count >= times) {
          debugLog('All bells played, finishing');
          playVisualAlarm(false);
          updatePlayButton(false);
          isAlarmPlaying = false;
          return;
        }
        playSingleAlarm(count + 1, times);
        count++;
        pendingNextTimeout = setTimeout(playNext, (bellDuration * 1000) + gapMs);
      }
      logBellPlay(triggerType, times);
      debugLog('playAlarmSequence: start playNext');
      playNext();
    }

    // å–®æ¬¡é˜è²æ’­æ”¾
    function playSingleAlarm(current, total) {
      // å…ˆç§»é™¤èˆŠçš„ onendedï¼Œé¿å…é‡è¤‡è§¸ç™¼
      alarmSound.onended = null;
      alarmSound.onended = function() {
        debugLog('alarmSound ended, call load()');
        alarmSound.load();
      };

      alarmSound.play()
        .then(()=>debugLog('alarmSound.play() resolved'))
        .catch((e)=>debugLog('alarmSound.play() error: '+e));

      debugLog(`Bell played: ${current} / ${total}`);
    }

    // æ‰‹å‹•æ’­æ”¾
    function playAlarm() {
      debugLog(`playAlarm() called, isAlarmPlaying=${isAlarmPlaying}`);
      if (isAlarmPlaying) {
        stopAlarm();
      } else {
        playAlarmSequence(4, 'æ‰‹å‹•');
      }
    }

    function stopAlarm() {
      debugLog('stopAlarm() called');
      if (!isAlarmPlaying) return;
      if (pendingNextTimeout) {
        debugLog('Clearing pendingNextTimeout');
        clearTimeout(pendingNextTimeout);
        pendingNextTimeout = null;
      }
      alarmSound.pause();
      alarmSound.currentTime = 0;
      playVisualAlarm(false);
      updatePlayButton(false);
      isAlarmPlaying = false;
    }

    function playVisualAlarm(enable = true) {
      const playButton = document.querySelector('.play-button');
      if (enable) {
        playButton.classList.add('flash');
      } else {
        playButton.classList.remove('flash');
      }
    }

    // æ›´æ–°æ‰‹å‹•æ•²é˜æŒ‰éˆ•æ–‡å­—
    function updatePlayButton(isPlaying = false) {
      const playTextDiv = document.querySelector('.play-text');
      if (!playTextDiv) return;
      if (isPlaying) {
        playTextDiv.innerHTML = 'é»æ­¤åœæ­¢é˜è²<br/>â¹ï¸';
      } else {
        playTextDiv.innerHTML = 'é»æ­¤æ‰‹å‹•æ•²é˜<br/>â–¶ï¸';
      }
    }

    function deletePastAlarms() {
      const today = getTodayDateFormatted();
      const originalCount = alarms.length;

      alarms = alarms.filter(alarm => alarm.date >= today);

      if (alarms.length < originalCount) {
        renderAlarms();
      }
    }

    class BellSchedulerUI {
      constructor() {
        // åœ¨ Google Apps Script ç’°å¢ƒä¸­ï¼Œä½¿ç”¨ç•¶å‰é é¢çš„ URL ä½œç‚º API åŸºç¤
        this.apiUrl = window.location.href.split('?')[0];
        this.initEventListeners();
        this.init();
      }

      async init() {
        // ç­‰å¾…éåŒæ­¥è¼‰å…¥å®Œæˆ
        await this.loadCourseData();
      }

      initEventListeners() {
        document.getElementById('keepaliveBtn').addEventListener('click', () => this.checkSystemStatus());
        document.getElementById('loadBtn').addEventListener('click', () => this.loadCourseData());
      }

      showStatus(message, type = 'loading') {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
        statusEl.classList.remove('hidden');
      }

      hideStatus() {
        document.getElementById('status').classList.add('hidden');
      }

      // å°ˆé–€è™•ç† Google Apps Script API å‘¼å«çš„æ–¹æ³•
      async callGoogleAppsScriptAPI(path) {
    debugLog('callGoogleAppsScriptAPI called: ' + path);
        return new Promise((resolve, reject) => {
          // åœ¨ Google Apps Script ç’°å¢ƒä¸­ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ google.script.run
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            // ä½¿ç”¨ Google Apps Script çš„å…§å»º API
            switch (path) {
              case 'course':
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler((error) => {
                    // è™•ç† Google Apps Script éŒ¯èª¤
                    const errorMessage = error && error.message ? error.message :
                      (typeof error === 'string' ? error : 'Network error');
                    reject(new Error(errorMessage));
                  })
                  .exportBellScheduleJSON();
                break;
              case 'keepalive':
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler((error) => {
                    // è™•ç† Google Apps Script éŒ¯èª¤
                    const errorMessage = error && error.message ? error.message :
                      (typeof error === 'string' ? error : 'Network error');
                    reject(new Error(errorMessage));
                  })
                  .getKeepAliveData();
                break;
              default:
                reject(new Error('Unknown API path'));
            }
          } else {
            // å¦‚æœä¸åœ¨ Google Apps Script ç’°å¢ƒä¸­ï¼Œä½¿ç”¨å‚³çµ±çš„ fetch
            this.callAPIWithFetch(path).then(resolve).catch(reject);
          }
        });
      }

      // å‚³çµ±çš„ fetch API å‘¼å«æ–¹æ³•ï¼ˆä½œç‚ºå‚™ç”¨ï¼‰
      async callAPIWithFetch(path) {
        const apiUrl = `${this.apiUrl}?path=${path}`;

        try {
          const response = await fetch(apiUrl);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const responseText = await response.text();

          // å˜—è©¦å¾ HTML å›æ‡‰ä¸­æå– JSON
          if (jsonMatch && jsonMatch.length > 0) {
            // æ‰¾åˆ°æœ€å¤§çš„ JSON å­—ä¸²ï¼ˆå¯èƒ½æ˜¯æˆ‘å€‘è¦çš„è³‡æ–™ï¼‰
            let largestJson = jsonMatch.reduce((a, b) => a.length > b.length ? a : b);
            try {
              return JSON.parse(largestJson);
            } catch (e) {
              // éœé»˜è™•ç†è§£æéŒ¯èª¤
            }
          }

          // å¦‚æœæ‰¾ä¸åˆ° JSONï¼Œå˜—è©¦ç›´æ¥è§£æ
          try {
            return JSON.parse(responseText);
          } catch (e) {
            throw new Error('ç„¡æ³•å¾ä¼ºæœå™¨å›æ‡‰ä¸­è§£æ JSON è³‡æ–™');
          }
        } catch (error) {
          // è™•ç†ç¶²è·¯é€£ç·šéŒ¯èª¤
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            throw new Error('Network error');
          } else {
            throw error;
          }
        }
      }


      async checkSystemStatus() {
    debugLog('checkSystemStatus() called');
        try {
          this.showStatus('ğŸ’“ Checking...', 'loading');

          // å‘¼å« keepalive API ç²å–ç³»çµ±ç‹€æ…‹
          debugLog('Calling keepalive API');
      const data = await this.callGoogleAppsScriptAPI('keepalive');
      debugLog('keepalive API response: ' + JSON.stringify(data));

          if (data.status === 'OK') {
            const lastDataChangeTime = JSON.stringify(data.lastDataChange)
            const lastDataChangeLocal = localStorage.getItem('lastDataChange');

            let statusMessage = `âœ… Version ${lastDataChangeTime}`;

            if (lastDataChangeTime !== lastDataChangeLocal) {
              const app = new BellSchedulerUI();
              app.loadCourseData();

              localStorage.setItem('lastDataChange', JSON.stringify(data.lastDataChange));
            }

            if (data.systemConfig && data.systemConfig.KeepAliveInterval) {
              // statusMessage += ` (Keep-Alive: ${data.systemConfig.KeepAliveInterval}åˆ†é˜)`;
              localStorage.setItem('keepAliveInterval', JSON.stringify(data.systemConfig.KeepAliveInterval));
            }
            const statusBox = document.getElementById('status');
            statusBox.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> ${statusMessage}</div>`;
          } else {
            this.showStatus('âš ï¸ ç³»çµ±ç‹€æ…‹ç•°å¸¸', 'error');
          }

          // ç§»é™¤è‡ªå‹•éš±è—ï¼Œè®“ JSON çµæœä¿æŒé¡¯ç¤º
          // setTimeout(() => this.hideStatus(), 5000);

        } catch (error) {
          this.showStatus(`âŒ ${error.message}`, 'error');
        }
      }

      async loadCourseData() {
        try {
          localStorage.removeItem('alarms');

          // this.showStatus('ğŸ”„ Loading...', 'loading');

          // ä½¿ç”¨ Google Apps Script çš„ç‰¹æ®Šæ–¹å¼å‘¼å« API
          const data = await this.callGoogleAppsScriptAPI('course');

          this.updateAlarmData(data);

          // this.showStatus('âœ…', 'success');

          // setTimeout(() => this.hideStatus(), 3000);


        } catch (error) {
          this.showStatus(`âŒ ${error.message}`, 'error');
        }
      }

      updateAlarmData(data) {
        syncAlarm(data);
        sortAlarms();
        renderAlarms();
      }
    }

    // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
    document.addEventListener('DOMContentLoaded', () => {
      // new BellSchedulerUI();
      const bellApp = new BellSchedulerUI();
      bellApp.checkSystemStatus();
      const keepAliveInterval = localStorage.getItem('keepAliveInterval') || 0.5;
      console.log(keepAliveInterval)

      // é€£ç·šæª¢æŸ¥å™¨
      debugLog('Setting keepalive interval: ' + keepAliveInterval + ' min');
      setInterval(() => {
        debugLog('Interval triggered: checkSystemStatus');
        bellApp.checkSystemStatus();
      }, keepAliveInterval * 60000);

    });

    function getTodayDateFormatted() {
      const today = new Date();

      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0'); // æœˆä»½å¾ 0 é–‹å§‹
      const day = String(today.getDate()).padStart(2, '0');

      return `${year}-${month}-${day}`;
    }

    renderAlarms();

  </script>


  <script>
    // Debug log å‡½å¼
    function debugLog(msg) {
      const logDiv = document.getElementById('debug-log');
      const now = new Date().toLocaleTimeString();
      if (typeof msg !== 'string') msg = JSON.stringify(msg);
      logDiv.innerHTML += `<div>[${now}] ${msg}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log('[DEBUG]', msg);
    }
  </script>
</body>

</html>