<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dhamma Gong</title>
  <style>
    .play-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 30vh;
      background-color: #707070;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      color: white;
      font-size: 5vh;
      font-weight: bold;
      margin-bottom: 10px;
    }



    .play-button:hover {
      background-color: #212121;
    }

    .play-button.flash {
      animation: flash-bg 3s ease-in-out infinite;
    }

    @keyframes flash-bg {
      0% {
        background-color: #707070;
      }

      50% {
        background-color: #212121;
      }

      100% {
        background-color: #707070;
      }
    }

    .play-icon {
      width: 0;
      height: 0;
      border-top: 5vh solid transparent;
      border-bottom: 5vh solid transparent;
      border-left: 8vh solid white;
    }

    .play-text {
      flex-grow: 1;
    }

    .date-block {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }

    .date-block h3 {
      margin: 0;
      display: flex;
      justify-content: space-between;
    }

    .buttons {
      margin-top: 10px;
    }

    .buttons button {
      margin-right: 5px;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .control-panel {
      margin-bottom: 20px;
    }

    .btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn:hover {
      background-color: #218838;
    }

    .btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .status {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
    }

    .status.loading {
      background-color: #d1ecf1;
      color: #0c5460;
    }

    .status.success {
      background-color: #d4edda;
      color: #155724;
    }

    .status.error {
      background-color: #f8d7da;
      color: #721c24;
    }

    .card {
      background-color: #f8f9fa;
      padding: 15px;
      margin-bottom: 10px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
    }

    .schedule-item {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .schedule-item:last-child {
      border-bottom: none;
    }

    .type {
      background-color: #007bff;
      color: white;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 12px;
    }

    .pattern-card {
      background-color: white;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .pattern-title {
      font-weight: bold;
      margin-bottom: 8px;
    }

    .bell-item {
      padding: 5px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .bell-item:last-child {
      border-bottom: none;
    }

    .hidden {
      display: none;
    }
  </style>
  <script>
    // Debug log ÂáΩÂºèÔºàÊîæÂà∞ÊâÄÊúâ JS ‰πãÂâçÔºâ
    function debugLog(msg) {
      const logDiv = document.getElementById('debug-log');
      const now = new Date().toLocaleTimeString();
      if (typeof msg !== 'string') msg = JSON.stringify(msg);
      if (logDiv) {
        logDiv.innerHTML += `<div>[${now}] ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }
      console.log('[DEBUG]', msg);
    }
  </script>
</head>

<body>
  <button class="play-button" onclick="playAlarm()">
    <div class="play-text">ÈªûÊ≠§ÊâãÂãïÊï≤Èêò<br />‚ñ∂Ô∏è</div>
  </button>

  <div class="container">
    <div class="control-panel">
      <button id="keepaliveBtn" class="btn hidden">üíì Check</button>
      <button id="loadBtn" class="btn hidden">üì• Load</button>
    </div>
    <div id="audio-error" class="status error hidden"></div>
    <div id="status" class="status hidden"></div>
    <div id="audio-unlock" class="status info">
      Ë´ãÈªûÊìäÁï´Èù¢‰ª•ÂïüÁî®ÈêòËÅ≤üîì
    </div>

    <div id="bell-log" style="max-height:120px;overflow:auto;background:#f6f6f6;border:1px solid #ccc;padding:8px;margin-bottom:8px;font-size:14px;"></div>

    <!-- Debug Log ÂçÄÂ°äÔºåÁßªÂà∞Ë°åÁ®ãË°®ÂâçÈù¢ -->
    <style>
      .audio-test-tools {
        background: #292929;
        border-radius: 8px;
        border: 1.5px solid #444;
        padding: 14px 18px 10px 12px;
        margin-bottom: 16px;
        max-width: 100%;
        box-sizing: border-box;
      }
      .audio-test-tools legend {
        color: #0f0;
        font-size: 14px;
        font-weight: bold;
        letter-spacing: 1px;
        margin-bottom: 4px;
      }
      .audio-test-btns {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 10px;
        margin-top: 2px;
      }
      .audio-test-btns button {
        background: #232323;
        color: #0f0;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 6px 14px;
        font-size: 13px;
        margin: 0;
        cursor: pointer;
        transition: background 0.18s, color 0.18s, box-shadow 0.18s;
      }
      .audio-test-btns button:hover {
        background: #0f0;
        color: #222;
        box-shadow: 0 0 0 2px #0f0 inset;
      }
    </style>
    <div class="audio-test-tools">
      <fieldset style="border:none;padding:0;margin:0;min-width:0;">
        <legend>Èü≥Ë®äÊ∏¨Ë©¶Â∑•ÂÖ∑</legend>
        <div class="audio-test-btns">
          <button onclick="alarmSound.muted=true; debugLog('alarmSound.muted = true');">muted = true</button>
          <button onclick="alarmSound.muted=false; debugLog('alarmSound.muted = false');">muted = false</button>
          <button onclick="alarmSound.pause(); debugLog('alarmSound.pause()');">pause()</button>
          <button onclick="alarmSound.play().then(()=>debugLog('alarmSound.play() resolved')).catch(e=>debugLog('alarmSound.play() error: '+e)); debugLog('alarmSound.play() called');">play()</button>
          <button onclick="debugLog('currentTime: ' + alarmSound.currentTime);">print currentTime</button>
          <button onclick="debugLog('isPlaying: ' + (!alarmSound.paused));">print isPlaying</button>
          <button onclick="alarmSound.currentTime=0; debugLog('alarmSound.currentTime = 0');">currentTime = 0</button>
          <button onclick="playSingleAlarm(1,1); debugLog('PlaySingleAlarm()');">PlaySingleAlarm()</button>
          <button onclick="stopAlarm(); debugLog('stopAlarm()');">stopAlarm()</button>
        </div>
      </fieldset>
    </div>
    <div id="debug-log" style="background:#222;color:#0f0;font-size:12px;max-height:200px;overflow:auto;padding:8px;margin-bottom:12px;border-radius:6px;"></div>
    <div id="date-list"></div>

  </div>

  <!-- <audio id="alarm-sound" src="https://discourses.dhamma.org/oml/recordings/uuid/b9ddfddd-163d-484e-9588-cb34ab524dc2.mp3" preload="auto"></audio> -->
  <audio id="alarm-sound" type="audio/mp3" preload="auto">
    <source src="">
  </audio>

  <script>
    // Load bell sound 
    <?!= include('belljs') ?>

    const alarmSound = document.getElementById('alarm-sound');
    let source = alarmSound.querySelector('source');
    if (!source) {
      source = document.createElement('source');
      alarmSound.appendChild(source);
    }
    source.src = BELL_BASE64;
    alarmSound.load();

    alarmSound.muted = false;
    alarmSound.volume = 1.0;

    // Unlock audio
    const audioUnlockDiv = document.getElementById('audio-unlock');
    let audioUnlocked = false;

    function showAudioUnlockMsg(msg) {
      audioUnlockDiv.textContent = msg;
      audioUnlockDiv.classList.remove('hidden');
    }

    function hideAudioUnlockMsg() {
      audioUnlockDiv.classList.add('hidden');
    }

    function unlockAudio() {
      if (audioUnlocked) return;
      const alarmSound = document.getElementById('alarm-sound');
      alarmSound.muted = true;
      alarmSound.play()
        .then(() => {
          alarmSound.pause();
          alarmSound.currentTime = 0;
          alarmSound.muted = false;
          audioUnlocked = true;
          showAudioUnlockMsg('Èü≥Ë®äÂ∑≤Ëß£ÈéñÔºÅüîä');
          setTimeout(hideAudioUnlockMsg, 1500);
        })
        .catch(() => {
          showAudioUnlockMsg('Ë´ãÈªûÊìäÁï´Èù¢‰ª•ÂïüÁî®ÈêòËÅ≤üîì');
        });
    }

    window.addEventListener('touchstart', unlockAudio, { once: true });
    window.addEventListener('click', unlockAudio, { once: true });
    showAudioUnlockMsg('Ë´ãÈªûÊìäÁï´Èù¢‰ª•ÂïüÁî®ÈêòËÅ≤üîì');
    // ===============================

    const dateList = document.getElementById('date-list');
    let alarms = []; // Â≠òÊîæÊâÄÊúâÈ¨ßÈêòË≥áÊñô
    let bellConfig = {}; // BellType Â∞çÊáâÈáçË§áÊ¨°Êï∏ÁöÑË®≠ÂÆö
    let isAlarmPlaying = false; // ÊòØÂê¶Ê≠£Âú®Êí≠ÊîæÈêòËÅ≤
    let pendingNextTimeout = null; // ‰∏ã‰∏ÄËÅ≤ÁöÑ timeout id

    // Êñ∞Â¢ûÈ¨ßÈêò
    function syncAlarm(data) {
      // ËÆÄÂèñ BellConfig (BellType -> Repeat)
      if (Array.isArray(data.BellConfig)) {
        bellConfig = data.BellConfig.reduce((acc, row) => {
          const key = row.bellType ?? row.BellType ?? row.type;
          const repeat = row.repeat ?? row.Repeat ?? row.count;
          if (key != null) acc[key] = repeat || 1;
          return acc;
        }, {});
      } else {
        bellConfig = { ...data.BellConfig };
      }


      alarms = [];
      data.CourseSchedule.forEach(course => {
        const courseDayCount = data.CourseTypes[course.courseType].length
        const dates = generateDateArray(course.startDate, courseDayCount);

        dates.forEach((date, index) => {
          const patternId = data.CourseTypes[course.courseType][index].dailyPattern
          const items = data.DailyPatterns[patternId];
          // Á¢∫Ë™çÊòØÂê¶Â∑≤ÊúâË©≤Êó•ÊúüÔºåËã•ÊúâÂâáÂêà‰ΩµÊôÇÈñì
          const existingAlarm = alarms.find(alarm => alarm.date === date);
          if (existingAlarm) {
            items.forEach(({ time, bellType }) => {
              existingAlarm.times = Array.from(new Set([...existingAlarm.times, time])).sort();
              existingAlarm.bellTypes[time] = bellType;
            });
          } else {
            const timesWithType = items.reduce((acc, it) => {
              acc.times.push(it.time);
              acc.bellTypes[it.time] = it.bellType;
              return acc;
            }, { times: [], bellTypes: {} });
            alarms.push({ date, times: Array.from(new Set(timesWithType.times)).sort(), bellTypes: timesWithType.bellTypes });
          }
        })

      })

      deletePastAlarms();
      sortAlarms();
      renderAlarms();
    }

    function generateDateArray(startDateStr, days) {
      const result = [];
      const startDate = new Date(startDateStr);

      for (let i = 0; i < days; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);

        // Ê†ºÂºèÂåñÊàê YYYY-MM-DD
        const formatted = date.toISOString().split('T')[0];
        result.push(formatted);
      }

      return result;
    }



    function showAudioError(msg) {
      const errDiv = document.getElementById('audio-error');
      errDiv.textContent = msg;
      errDiv.classList.remove('hidden');
    }
    function hideAudioError() {
      const errDiv = document.getElementById('audio-error');
      errDiv.textContent = '';
      errDiv.classList.add('hidden');
    }
    // ‰æùÊó•ÊúüÂçáÂÜ™ÊéíÂàó
    function sortAlarms() {
      alarms.sort((a, b) => new Date(a.date) - new Date(b.date));

      // ÊØèÂÄãÊó•ÊúüÂÖßÁöÑÊôÇÈñì‰πüÂçáÂÜ™ÊéíÂàó
      alarms.forEach(alarm => {
        alarm.times.sort((a, b) => {
          const [ha, ma] = a.split(':').map(Number);
          const [hb, mb] = b.split(':').map(Number);
          return ha !== hb ? ha - hb : ma - mb;
        });
      });
    }

    // Ê∏≤ÊüìÈ¨ßÈêòÂàóË°®
    function renderAlarms() {
      dateList.innerHTML = '';

      alarms
        .forEach((alarm, index) => {
          const block = document.createElement('div');
          block.className = 'date-block';

          block.innerHTML = `
                <h3>${alarm.date}
                </h3>
                <p>üîî ${alarm.times.join(', ')}</p>
            `;
          dateList.appendChild(block);
        });
    }

    function runEveryMinuteAtZeroSecond() {
      const now = new Date();
      const next = new Date(now);

      next.setSeconds(0);
      next.setMilliseconds(0);
      next.setMinutes(now.getMinutes() + 1); // ‰∏ã‰∏ÄÂàÜÈêòÁöÑ 0 Áßí

      const delay = next - now; // Ââ©È§òÊôÇÈñìÔºàÊØ´ÁßíÔºâ

      debugLog('runEveryMinuteAtZeroSecond: scheduling next minute task, delay=' + delay);
      setTimeout(() => {
        const hh = String(next.getHours()).padStart(2, '0');
        const mm = String(next.getMinutes()).padStart(2, '0');
        const currentTime = `${hh}:${mm}`;

        debugLog('ÊØèÂàÜÈêòÁöÑÁ¨¨ 0 ÁßíÂü∑Ë°å‰ªªÂãô: ' + currentTime);
        if (alarms && alarms.length > 0 && alarms[0].date === getTodayDateFormatted() && alarms[0].times.includes(currentTime)) {
          const bellType = alarms[0].bellTypes[currentTime] || 1;
          const repeatTimes = bellConfig[bellType] || 1;
          debugLog(`Ëá™ÂãïÊí≠ÊîæÈêòËÅ≤: type=${bellType}, repeat=${repeatTimes}`);
          playAlarmSequence(repeatTimes, 'Ëá™Âãï');
        }
        // ÂÅöÂÆåÂæåÂÜçÂÆâÊéí‰∏ã‰∏ÄÊ¨°
        runEveryMinuteAtZeroSecond();
      }, delay);
    }

    runEveryMinuteAtZeroSecond();

    function scheduleMidnightTask() {
      const now = new Date();
      const nextMidnight = new Date();

      nextMidnight.setDate(now.getDate() + 1); // ÊòéÂ§©
      nextMidnight.setHours(0, 0, 0, 0); // Ë®≠ÁÇ∫ 00:00:00.000

      const timeUntilMidnight = nextMidnight - now;

      setTimeout(() => {
        // ‚úÖ Âú® 0:00 Âü∑Ë°å‰Ω†ÁöÑ‰ªªÂãô
        console.log("üïõ ÊØèÊó•ÂçàÂ§ú‰ªªÂãôÂü∑Ë°åÔºÅ");
        deletePastAlarms();

        // ÁÑ∂ÂæåÂÜçÊ¨°ÊéíÁ®ãÊòéÂ§©ÁöÑ 0:00
        scheduleMidnightTask();
      }, timeUntilMidnight);
    }

    scheduleMidnightTask();

    // Êí≠ÊîæÈêòËÅ≤Á¥ÄÈåÑ
    function logBellPlay(type, times) {
      const logDiv = document.getElementById('bell-log');
      if (!logDiv) return;
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, '0');
      const mm = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');
      const msg = `[${hh}:${mm}:${ss}] ${type} Êí≠ÊîæÈêòËÅ≤ x${times}`;
      // ÊèíÂÖ•ÊúÄ‰∏äÊñπ
      logDiv.innerHTML = `<div>${msg}</div>` + logDiv.innerHTML;
      // ÊúÄÂ§öÂè™‰øùÁïô 20 Á≠Ü
      const logs = logDiv.querySelectorAll('div');
      if (logs.length > 20) {
        for(let i=20;i<logs.length;i++) logs[i].remove();
      }
    }

    // Êï≤ÈêòÊµÅÁ®ãÔºàÊâãÂãï/Ëá™ÂãïÂÖ±Áî®Ôºâ
    function playAlarmSequence(times = 1, triggerType = 'Ëá™Âãï') {
      debugLog(`playAlarmSequence called: times=${times}, triggerType=${triggerType}, isAlarmPlaying=${isAlarmPlaying}`);
      // stopAlarm(); // ‰øùÈö™ÔºöÂÖàÁ¢∫‰øùÁãÄÊÖã‰πæÊ∑®
      if (times < 1) return;
      isAlarmPlaying = true;
      playVisualAlarm(true);
      updatePlayButton(true);
      let count = 0;
      const gapMs = 300; // ÊØèËÅ≤‰πãÈñìÁöÑÈ°çÂ§ñÂÅúÈ†ì (ÊØ´Áßí)
      const bellDuration = 16; // Áßí

      function playNext() {
        debugLog(`playNext: count=${count}, times=${times}`);
        if (!isAlarmPlaying) {
          debugLog('playNext aborted: isAlarmPlaying is false');
          return;
        }
        if (count >= times) {
          debugLog('All bells played, finishing');
          playVisualAlarm(false);
          updatePlayButton(false);
          isAlarmPlaying = false;
          return;
        }
        playSingleAlarm(count + 1, times);
        count++;
        pendingNextTimeout = setTimeout(playNext, (bellDuration * 1000) + gapMs);
      }
      logBellPlay(triggerType, times);
      debugLog('playAlarmSequence: start playNext');
      playNext();
    }

    // ÂñÆÊ¨°ÈêòËÅ≤Êí≠Êîæ
    function playSingleAlarm(current, total) {
      // ÂÖàÁßªÈô§ËàäÁöÑ onendedÔºåÈÅøÂÖçÈáçË§áËß∏Áôº
      alarmSound.onended = null;
      alarmSound.onended = function() {
        debugLog('alarmSound ended, call load()');
        alarmSound.load();
      };

      alarmSound.play()
        .then(()=>debugLog('alarmSound.play() resolved'))
        .catch((e)=>debugLog('alarmSound.play() error: '+e));

      debugLog(`Bell played: ${current} / ${total}`);
    }

    // ÊâãÂãïÊí≠Êîæ
    function playAlarm() {
      debugLog(`playAlarm() called, isAlarmPlaying=${isAlarmPlaying}`);
      if (isAlarmPlaying) {
        stopAlarm();
      } else {
        playAlarmSequence(4, 'ÊâãÂãï');
      }
    }

    function stopAlarm() {
      debugLog('stopAlarm() called');
      if (!isAlarmPlaying) return;
      if (pendingNextTimeout) {
        debugLog('Clearing pendingNextTimeout');
        clearTimeout(pendingNextTimeout);
        pendingNextTimeout = null;
      }
      alarmSound.pause();
      alarmSound.currentTime = 0;
      playVisualAlarm(false);
      updatePlayButton(false);
      isAlarmPlaying = false;
    }

    function playVisualAlarm(enable = true) {
      const playButton = document.querySelector('.play-button');
      if (enable) {
        playButton.classList.add('flash');
      } else {
        playButton.classList.remove('flash');
      }
    }

    // Êõ¥Êñ∞ÊâãÂãïÊï≤ÈêòÊåâÈàïÊñáÂ≠ó
    function updatePlayButton(isPlaying = false) {
      const playTextDiv = document.querySelector('.play-text');
      if (!playTextDiv) return;
      if (isPlaying) {
        playTextDiv.innerHTML = 'ÈªûÊ≠§ÂÅúÊ≠¢ÈêòËÅ≤<br/>‚èπÔ∏è';
      } else {
        playTextDiv.innerHTML = 'ÈªûÊ≠§ÊâãÂãïÊï≤Èêò<br/>‚ñ∂Ô∏è';
      }
    }

    function deletePastAlarms() {
      const today = getTodayDateFormatted();
      const originalCount = alarms.length;

      alarms = alarms.filter(alarm => alarm.date >= today);

      if (alarms.length < originalCount) {
        renderAlarms();
      }
    }

    class BellSchedulerUI {
      constructor() {
        // Âú® Google Apps Script Áí∞Â¢É‰∏≠Ôºå‰ΩøÁî®Áï∂ÂâçÈ†ÅÈù¢ÁöÑ URL ‰ΩúÁÇ∫ API Âü∫Á§é
        this.apiUrl = window.location.href.split('?')[0];
        this.initEventListeners();
        this.init();
      }

      async init() {
        // Á≠âÂæÖÈùûÂêåÊ≠•ËºâÂÖ•ÂÆåÊàê
        await this.loadCourseData();
      }

      initEventListeners() {
        document.getElementById('keepaliveBtn').addEventListener('click', () => this.checkSystemStatus());
        document.getElementById('loadBtn').addEventListener('click', () => this.loadCourseData());
      }

      showStatus(message, type = 'loading') {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
        statusEl.classList.remove('hidden');
      }

      hideStatus() {
        document.getElementById('status').classList.add('hidden');
      }

      // Â∞àÈñÄËôïÁêÜ Google Apps Script API ÂëºÂè´ÁöÑÊñπÊ≥ï
      async callGoogleAppsScriptAPI(path) {
    debugLog('callGoogleAppsScriptAPI called: ' + path);
        return new Promise((resolve, reject) => {
          // Âú® Google Apps Script Áí∞Â¢É‰∏≠ÔºåÊàëÂÄëÂèØ‰ª•‰ΩøÁî® google.script.run
          if (typeof google !== 'undefined' && google.script && google.script.run) {
            // ‰ΩøÁî® Google Apps Script ÁöÑÂÖßÂª∫ API
            switch (path) {
              case 'course':
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler((error) => {
                    // ËôïÁêÜ Google Apps Script ÈåØË™§
                    const errorMessage = error && error.message ? error.message :
                      (typeof error === 'string' ? error : 'Network error');
                    reject(new Error(errorMessage));
                  })
                  .exportBellScheduleJSON();
                break;
              case 'keepalive':
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler((error) => {
                    // ËôïÁêÜ Google Apps Script ÈåØË™§
                    const errorMessage = error && error.message ? error.message :
                      (typeof error === 'string' ? error : 'Network error');
                    reject(new Error(errorMessage));
                  })
                  .getKeepAliveData();
                break;
              default:
                reject(new Error('Unknown API path'));
            }
          } else {
            // Â¶ÇÊûú‰∏çÂú® Google Apps Script Áí∞Â¢É‰∏≠Ôºå‰ΩøÁî®ÂÇ≥Áµ±ÁöÑ fetch
            this.callAPIWithFetch(path).then(resolve).catch(reject);
          }
        });
      }

      // ÂÇ≥Áµ±ÁöÑ fetch API ÂëºÂè´ÊñπÊ≥ïÔºà‰ΩúÁÇ∫ÂÇôÁî®Ôºâ
      async callAPIWithFetch(path) {
        const apiUrl = `${this.apiUrl}?path=${path}`;

        try {
          const response = await fetch(apiUrl);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const responseText = await response.text();

          // ÂòóË©¶Âæû HTML ÂõûÊáâ‰∏≠ÊèêÂèñ JSON
          if (jsonMatch && jsonMatch.length > 0) {
            // ÊâæÂà∞ÊúÄÂ§ßÁöÑ JSON Â≠ó‰∏≤ÔºàÂèØËÉΩÊòØÊàëÂÄëË¶ÅÁöÑË≥áÊñôÔºâ
            let largestJson = jsonMatch.reduce((a, b) => a.length > b.length ? a : b);
            try {
              return JSON.parse(largestJson);
            } catch (e) {
              // ÈùúÈªòËôïÁêÜËß£ÊûêÈåØË™§
            }
          }

          // Â¶ÇÊûúÊâæ‰∏çÂà∞ JSONÔºåÂòóË©¶Áõ¥Êé•Ëß£Êûê
          try {
            return JSON.parse(responseText);
          } catch (e) {
            throw new Error('ÁÑ°Ê≥ïÂæû‰º∫ÊúçÂô®ÂõûÊáâ‰∏≠Ëß£Êûê JSON Ë≥áÊñô');
          }
        } catch (error) {
          // ËôïÁêÜÁ∂≤Ë∑ØÈÄ£Á∑öÈåØË™§
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            throw new Error('Network error');
          } else {
            throw error;
          }
        }
      }


      async checkSystemStatus() {
    debugLog('checkSystemStatus() called');
        try {
          this.showStatus('üíì Checking...', 'loading');

          // ÂëºÂè´ keepalive API Áç≤ÂèñÁ≥ªÁµ±ÁãÄÊÖã
          debugLog('Calling keepalive API');
      const data = await this.callGoogleAppsScriptAPI('keepalive');
      debugLog('keepalive API response: ' + JSON.stringify(data));

          if (data.status === 'OK') {
            const lastDataChangeTime = JSON.stringify(data.lastDataChange)
            const lastDataChangeLocal = localStorage.getItem('lastDataChange');

            let statusMessage = `‚úÖ Version ${lastDataChangeTime}`;

            if (lastDataChangeTime !== lastDataChangeLocal) {
              const app = new BellSchedulerUI();
              app.loadCourseData();

              localStorage.setItem('lastDataChange', JSON.stringify(data.lastDataChange));
            }

            if (data.systemConfig && data.systemConfig.KeepAliveInterval) {
              // statusMessage += ` (Keep-Alive: ${data.systemConfig.KeepAliveInterval}ÂàÜÈêò)`;
              localStorage.setItem('keepAliveInterval', JSON.stringify(data.systemConfig.KeepAliveInterval));
            }
            const statusBox = document.getElementById('status');
            statusBox.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> ${statusMessage}</div>`;
          } else {
            this.showStatus('‚ö†Ô∏è Á≥ªÁµ±ÁãÄÊÖãÁï∞Â∏∏', 'error');
          }

          // ÁßªÈô§Ëá™ÂãïÈö±ËóèÔºåËÆì JSON ÁµêÊûú‰øùÊåÅÈ°ØÁ§∫
          // setTimeout(() => this.hideStatus(), 5000);

        } catch (error) {
          this.showStatus(`‚ùå ${error.message}`, 'error');
        }
      }

      async loadCourseData() {
        try {
          localStorage.removeItem('alarms');

          // this.showStatus('üîÑ Loading...', 'loading');

          // ‰ΩøÁî® Google Apps Script ÁöÑÁâπÊÆäÊñπÂºèÂëºÂè´ API
          const data = await this.callGoogleAppsScriptAPI('course');

          this.updateAlarmData(data);

          // this.showStatus('‚úÖ', 'success');

          // setTimeout(() => this.hideStatus(), 3000);


        } catch (error) {
          this.showStatus(`‚ùå ${error.message}`, 'error');
        }
      }

      updateAlarmData(data) {
        syncAlarm(data);
        sortAlarms();
        renderAlarms();
      }
    }

    // ÂàùÂßãÂåñÊáâÁî®Á®ãÂºè
    document.addEventListener('DOMContentLoaded', () => {
      // new BellSchedulerUI();
      const bellApp = new BellSchedulerUI();
      bellApp.checkSystemStatus();
      const keepAliveInterval = localStorage.getItem('keepAliveInterval') || 0.5;
      console.log(keepAliveInterval)

      // ÈÄ£Á∑öÊ™¢Êü•Âô®
      debugLog('Setting keepalive interval: ' + keepAliveInterval + ' min');
      setInterval(() => {
        debugLog('Interval triggered: checkSystemStatus');
        bellApp.checkSystemStatus();
      }, keepAliveInterval * 60000);

    });

    function getTodayDateFormatted() {
      const today = new Date();

      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0'); // Êúà‰ªΩÂæû 0 ÈñãÂßã
      const day = String(today.getDate()).padStart(2, '0');

      return `${year}-${month}-${day}`;
    }

    renderAlarms();

  </script>


  <script>
    // Debug log ÂáΩÂºè
    function debugLog(msg) {
      const logDiv = document.getElementById('debug-log');
      const now = new Date().toLocaleTimeString();
      if (typeof msg !== 'string') msg = JSON.stringify(msg);
      logDiv.innerHTML += `<div>[${now}] ${msg}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log('[DEBUG]', msg);
    }
  </script>
</body>

</html>