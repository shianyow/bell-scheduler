
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhamma Gong</title>
    <style>
        .play-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 30vh;
            background-color: #707070;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            color: white;
            font-size: 5vh;
            font-weight: bold;
            margin-bottom: 10px;
          }
      
  
      
          .play-button:hover {
            background-color: #212121;
          }

          .play-button.flash {
            animation: flash-bg 3s ease-in-out infinite;
        }
        
        @keyframes flash-bg {
            0% { background-color: #707070; }
            50% { background-color: #212121; }
            100% { background-color: #707070; }
        }
        
          .play-icon {
            width: 0;
            height: 0;
            border-top: 5vh solid transparent;
            border-bottom: 5vh solid transparent;
            border-left: 8vh solid white;
          }
      
          .play-text {
            flex-grow: 1;
          }

        .date-block {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        .date-block h3 {
            margin: 0;
            display: flex;
            justify-content: space-between;
        }
        .buttons {
            margin-top: 10px;
        }
        .buttons button {
            margin-right: 5px;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .control-panel {
            margin-bottom: 20px;
        }

        .btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:hover {
            background-color: #218838;
        }

        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .status {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .status.loading {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .card {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .schedule-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .schedule-item:last-child {
            border-bottom: none;
        }

        .type {
            background-color: #007bff;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
        }

        .pattern-card {
            background-color: white;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .pattern-title {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .bell-item {
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .bell-item:last-child {
            border-bottom: none;
        }

        .hidden {
            display: none;
        }        
    </style>
</head>
<body>
<button class="play-button" onclick="playAlarm()">
    <div class="play-text">é»æ­¤æ‰‹å‹•æ•²é˜<br/>â–¶ï¸</div>
</button>

<div class="container">
<div class="control-panel">
<button id="keepaliveBtn" class="btn hidden">ğŸ’“ Check</button>
<button id="loadBtn" class="btn hidden">ğŸ“¥ Load</button>
</div>
<div id="audio-error" class="status error hidden"></div>
<div id="status" class="status hidden"></div>
<div id="audio-unlock" class="status info">
    è«‹é»æ“Šç•«é¢ä»¥å•Ÿç”¨é˜è²ğŸ”“
</div>

<div id="date-list"></div>


</div>

<!-- <audio id="alarm-sound" src="https://discourses.dhamma.org/oml/recordings/uuid/b9ddfddd-163d-484e-9588-cb34ab524dc2.mp3" preload="auto"></audio> -->
<audio id="alarm-sound" type="audio/mp3" preload="auto">
    <source src="">
</audio>

<script>
    // Load bell sound 
    <?!= include('belljs') ?>

    const alarmSound = document.getElementById('alarm-sound');
    let source = alarmSound.querySelector('source');
    if (!source) {
        source = document.createElement('source');
        alarmSound.appendChild(source);
    }
    source.src = BELL_BASE64;
    alarmSound.load();

    alarmSound.muted = false;
    alarmSound.volume = 1.0;

    // Unlock audio
    const audioUnlockDiv = document.getElementById('audio-unlock');
    let audioUnlocked = false;

    function showAudioUnlockMsg(msg) {
      audioUnlockDiv.textContent = msg;
      audioUnlockDiv.classList.remove('hidden');
    }

    function hideAudioUnlockMsg() {
      audioUnlockDiv.classList.add('hidden');
    }

    function unlockAudio() {
      if (audioUnlocked) return;
      const alarmSound = document.getElementById('alarm-sound');
      alarmSound.muted = true;
      alarmSound.play()
        .then(() => {
          alarmSound.pause();
          alarmSound.currentTime = 0;
          alarmSound.muted = false;
          audioUnlocked = true;
          showAudioUnlockMsg('éŸ³è¨Šå·²è§£é–ï¼ğŸ”Š');
          setTimeout(hideAudioUnlockMsg, 1500);
        })
        .catch(() => {
          showAudioUnlockMsg('è«‹é»æ“Šç•«é¢ä»¥å•Ÿç”¨é˜è²ğŸ”“');
        });
    }

    window.addEventListener('touchstart', unlockAudio, { once: true });
    window.addEventListener('click', unlockAudio, { once: true });
    showAudioUnlockMsg('è«‹é»æ“Šç•«é¢ä»¥å•Ÿç”¨é˜è²ğŸ”“');
    // ===============================

    const dateList = document.getElementById('date-list');
    let alarms = []; // å­˜æ”¾æ‰€æœ‰é¬§é˜è³‡æ–™
    let bellConfig = {}; // BellType å°æ‡‰é‡è¤‡æ¬¡æ•¸çš„è¨­å®š
    let isAlarmPlaying = false; // æ˜¯å¦æ­£åœ¨æ’­æ”¾é˜è²
    let pendingNextTimeout = null; // ä¸‹ä¸€è²çš„ timeout id

    // æ–°å¢é¬§é˜
    function syncAlarm(data) {
    // è®€å– BellConfig (BellType -> Repeat)
    if (Array.isArray(data.BellConfig)) {
        bellConfig = data.BellConfig.reduce((acc, row) => {
            const key = row.bellType ?? row.BellType ?? row.type;
            const repeat = row.repeat ?? row.Repeat ?? row.count;
            if (key != null) acc[key] = repeat || 1;
            return acc;
        }, {});
    } else {
        bellConfig = { ...data.BellConfig };
    }


        alarms = [];
        data.CourseSchedule.forEach(course =>{
            const courseDayCount = data.CourseTypes[course.courseType].length
            const dates = generateDateArray(course.startDate, courseDayCount);

            dates.forEach((date, index) =>{
                const patternId = data.CourseTypes[course.courseType][index].dailyPattern
                const items = data.DailyPatterns[patternId];
                // ç¢ºèªæ˜¯å¦å·²æœ‰è©²æ—¥æœŸï¼Œè‹¥æœ‰å‰‡åˆä½µæ™‚é–“
                const existingAlarm = alarms.find(alarm => alarm.date === date);
                if (existingAlarm) {
                    items.forEach(({ time, bellType }) => {
                existingAlarm.times = Array.from(new Set([...existingAlarm.times, time])).sort();
                existingAlarm.bellTypes[time] = bellType;
            });
                } else {
                    const timesWithType = items.reduce((acc, it) => {
                    acc.times.push(it.time);
                    acc.bellTypes[it.time] = it.bellType;
                    return acc;
                }, { times: [], bellTypes: {} });
                alarms.push({ date, times: Array.from(new Set(timesWithType.times)).sort(), bellTypes: timesWithType.bellTypes });
                }                            
            })

        })

        deletePastAlarms();
        sortAlarms();
        renderAlarms();
    }

    function generateDateArray(startDateStr, days) {
        const result = [];
        const startDate = new Date(startDateStr);
      
        for (let i = 0; i < days; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          
          // æ ¼å¼åŒ–æˆ YYYY-MM-DD
          const formatted = date.toISOString().split('T')[0];
          result.push(formatted);
        }
      
        return result;
      }
      
      

function showAudioError(msg) {
    const errDiv = document.getElementById('audio-error');
    errDiv.textContent = msg;
    errDiv.classList.remove('hidden');
}
function hideAudioError() {
    const errDiv = document.getElementById('audio-error');
    errDiv.textContent = '';
    errDiv.classList.add('hidden');
}
// ä¾æ—¥æœŸå‡å†ªæ’åˆ—
function sortAlarms() {
    alarms.sort((a, b) => new Date(a.date) - new Date(b.date));

    // æ¯å€‹æ—¥æœŸå…§çš„æ™‚é–“ä¹Ÿå‡å†ªæ’åˆ—
    alarms.forEach(alarm => {
        alarm.times.sort((a, b) => {
            const [ha, ma] = a.split(':').map(Number);
            const [hb, mb] = b.split(':').map(Number);
            return ha !== hb ? ha - hb : ma - mb;
        });
    });
}

    // æ¸²æŸ“é¬§é˜åˆ—è¡¨
    function renderAlarms() {
        dateList.innerHTML = '';

        alarms
        .forEach((alarm, index) => {
            const block = document.createElement('div');
            block.className = 'date-block';

            block.innerHTML = `
                <h3>${alarm.date}
                </h3>
                <p>ğŸ”” ${alarm.times.join(', ')}</p>
            `;
            dateList.appendChild(block);
        });
    }




    function runEveryMinuteAtZeroSecond() {
        const now = new Date();
        const next = new Date(now);

        next.setSeconds(0);
        next.setMilliseconds(0);
        next.setMinutes(now.getMinutes() + 1); // ä¸‹ä¸€åˆ†é˜çš„ 0 ç§’
      
        const delay = next - now; // å‰©é¤˜æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
      
        setTimeout(() => {
          const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()+1).padStart(2, '0')}`;


          // âœ… åœ¨æ¯åˆ†é˜çš„ 0 ç§’åŸ·è¡Œé€™æ®µ
          console.log("â° æ¯åˆ†é˜çš„ç¬¬ 0 ç§’åŸ·è¡Œä»»å‹™", new Date().toLocaleTimeString());
          if (alarms && alarms[0].date === getTodayDateFormatted() && alarms[0].times.includes(currentTime)) {
        const bellType = alarms[0].bellTypes[currentTime] || 1;
        const repeatTimes = bellConfig[bellType] || 1;
            playAlarmTimes(repeatTimes);
        }
          // åšå®Œå¾Œå†å®‰æ’ä¸‹ä¸€æ¬¡
          runEveryMinuteAtZeroSecond();
        }, delay);
      }
      
      runEveryMinuteAtZeroSecond();
      

    function scheduleMidnightTask() {
        const now = new Date();
        const nextMidnight = new Date();
      
        nextMidnight.setDate(now.getDate() + 1); // æ˜å¤©
        nextMidnight.setHours(0, 0, 0, 0); // è¨­ç‚º 00:00:00.000
      
        const timeUntilMidnight = nextMidnight - now;
      
        setTimeout(() => {
          // âœ… åœ¨ 0:00 åŸ·è¡Œä½ çš„ä»»å‹™
          console.log("ğŸ•› æ¯æ—¥åˆå¤œä»»å‹™åŸ·è¡Œï¼");
          deletePastAlarms();
                
          // ç„¶å¾Œå†æ¬¡æ’ç¨‹æ˜å¤©çš„ 0:00
          scheduleMidnightTask();
        }, timeUntilMidnight);
      }
      
      scheduleMidnightTask();

  function playAlarmTimes(times = 1) {
    if (isAlarmPlaying) return; // å·²åœ¨æ’­æ”¾
    isAlarmPlaying = true;
    const gapMs = 300; // æ¯è²ä¹‹é–“çš„é¡å¤–åœé “ (æ¯«ç§’)
    let count = 0;

    // é–‹å•Ÿè¦–è¦ºæ•ˆæœ
    playVisualAlarm(true);
    updatePlayButton(true);

    const playNext = () => {
      if (count >= times) {
        // å…¨éƒ¨æ’­æ”¾å®Œï¼Œé—œé–‰è¦–è¦ºæ•ˆæœ
        playVisualAlarm(false);
        updatePlayButton(false);
        isAlarmPlaying = false;
        return;
      }

      alarmSound.currentTime = 0;
      alarmSound.play().catch(() => {});
      count += 1;

      // ç­‰å¾…éŸ³æª”æ’­ç•¢å¾Œå†æ’­æ”¾ä¸‹ä¸€è²
      alarmSound.addEventListener(
        'ended',
        () => {
        pendingNextTimeout = setTimeout(playNext, gapMs);
      },
      { once: true }
    );
  };

  playNext();
}

// æ‰‹å‹•æ’­æ”¾
function playAlarm() {
  if (isAlarmPlaying) {
    stopAlarm();
  } else {
    playAlarmTimes(3);
  }
}

function stopAlarm() {
    if (!isAlarmPlaying) return;
    if (pendingNextTimeout) {
        clearTimeout(pendingNextTimeout);
        pendingNextTimeout = null;
    }
    alarmSound.pause();
    alarmSound.currentTime = 0;
    playVisualAlarm(false);
    updatePlayButton(false);
    isAlarmPlaying = false;
}

function playVisualAlarm(enable = true) {
    const playButton = document.querySelector('.play-button');
    if (enable) {
        playButton.classList.add('flash');
    } else {
        playButton.classList.remove('flash');
    }
}

// æ›´æ–°æ‰‹å‹•æ•²é˜æŒ‰éˆ•æ–‡å­—
function updatePlayButton(isPlaying = false) {
    const playTextDiv = document.querySelector('.play-text');
    if (!playTextDiv) return;
    if (isPlaying) {
        playTextDiv.innerHTML = 'é»æ­¤åœæ­¢é˜è²<br/>â¹ï¸';
    } else {
        playTextDiv.innerHTML = 'é»æ­¤æ‰‹å‹•æ•²é˜<br/>â–¶ï¸';
    }
}

function deletePastAlarms() {
    const today = getTodayDateFormatted();
    const originalCount = alarms.length;

    alarms = alarms.filter(alarm => alarm.date >= today);

    if (alarms.length < originalCount) {
        renderAlarms();
    }
}

class BellSchedulerUI {
    constructor() {
        // åœ¨ Google Apps Script ç’°å¢ƒä¸­ï¼Œä½¿ç”¨ç•¶å‰é é¢çš„ URL ä½œç‚º API åŸºç¤
        this.apiUrl = window.location.href.split('?')[0];
        this.initEventListeners();
        this.init();
    }

    async init() {
        // ç­‰å¾…éåŒæ­¥è¼‰å…¥å®Œæˆ
        await this.loadCourseData();
    }

    initEventListeners() {
        document.getElementById('keepaliveBtn').addEventListener('click', () => this.checkSystemStatus());
        document.getElementById('loadBtn').addEventListener('click', () => this.loadCourseData());
    }

    showStatus(message, type = 'loading') {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
        statusEl.classList.remove('hidden');
    }

    hideStatus() {
        document.getElementById('status').classList.add('hidden');
    }

    // å°ˆé–€è™•ç† Google Apps Script API å‘¼å«çš„æ–¹æ³•
    async callGoogleAppsScriptAPI(path) {
        return new Promise((resolve, reject) => {
            // åœ¨ Google Apps Script ç’°å¢ƒä¸­ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ google.script.run
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                // ä½¿ç”¨ Google Apps Script çš„å…§å»º API
                switch(path) {
                    case 'course':
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler((error) => {
                                // è™•ç† Google Apps Script éŒ¯èª¤
                                const errorMessage = error && error.message ? error.message : 
                                                   (typeof error === 'string' ? error : 'Network error');
                                reject(new Error(errorMessage));
                            })
                            .exportBellScheduleJSON();
                        break;
                    case 'keepalive':
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler((error) => {
                                // è™•ç† Google Apps Script éŒ¯èª¤
                                const errorMessage = error && error.message ? error.message : 
                                                   (typeof error === 'string' ? error : 'Network error');
                                reject(new Error(errorMessage));
                            })
                            .getKeepAliveData();
                        break;
                    default:
                        reject(new Error('Unknown API path'));
                }
            } else {
                // å¦‚æœä¸åœ¨ Google Apps Script ç’°å¢ƒä¸­ï¼Œä½¿ç”¨å‚³çµ±çš„ fetch
                this.callAPIWithFetch(path).then(resolve).catch(reject);
            }
        });
    }

            // å‚³çµ±çš„ fetch API å‘¼å«æ–¹æ³•ï¼ˆä½œç‚ºå‚™ç”¨ï¼‰
            async callAPIWithFetch(path) {
                const apiUrl = `${this.apiUrl}?path=${path}`;
                
                try {
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const responseText = await response.text();
                    
                    // å˜—è©¦å¾ HTML å›æ‡‰ä¸­æå– JSON
                    if (jsonMatch && jsonMatch.length > 0) {
                        // æ‰¾åˆ°æœ€å¤§çš„ JSON å­—ä¸²ï¼ˆå¯èƒ½æ˜¯æˆ‘å€‘è¦çš„è³‡æ–™ï¼‰
                        let largestJson = jsonMatch.reduce((a, b) => a.length > b.length ? a : b);
                        try {
                            return JSON.parse(largestJson);
                        } catch (e) {
                            // éœé»˜è™•ç†è§£æéŒ¯èª¤
                        }
                    }
                    
                    // å¦‚æœæ‰¾ä¸åˆ° JSONï¼Œå˜—è©¦ç›´æ¥è§£æ
                    try {
                        return JSON.parse(responseText);
                    } catch (e) {
                        throw new Error('ç„¡æ³•å¾ä¼ºæœå™¨å›æ‡‰ä¸­è§£æ JSON è³‡æ–™');
                    }
                } catch (error) {
                    // è™•ç†ç¶²è·¯é€£ç·šéŒ¯èª¤
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        throw new Error('Network error');
                    } else {
                        throw error;
                    }
                }
            }


    async checkSystemStatus() {
        try {
            this.showStatus('ğŸ’“ Checking...', 'loading');
            
            // å‘¼å« keepalive API ç²å–ç³»çµ±ç‹€æ…‹
            const data = await this.callGoogleAppsScriptAPI('keepalive');
            
            if (data.status === 'OK') {
                const lastDataChangeTime = JSON.stringify(data.lastDataChange)
                const lastDataChangeLocal = localStorage.getItem('lastDataChange');

                let statusMessage = `âœ… Version ${lastDataChangeTime}`;

                if (lastDataChangeTime !== lastDataChangeLocal){
                    const app = new BellSchedulerUI();
                    app.loadCourseData();

                    localStorage.setItem('lastDataChange', JSON.stringify(data.lastDataChange));
                }

                if (data.systemConfig && data.systemConfig.KeepAliveInterval) {
                    // statusMessage += ` (Keep-Alive: ${data.systemConfig.KeepAliveInterval}åˆ†é˜)`;
                    localStorage.setItem('keepAliveInterval', JSON.stringify(data.systemConfig.KeepAliveInterval));
                }
                const statusBox = document.getElementById('status');
                statusBox.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> ${statusMessage}</div>`;
            } else {
                this.showStatus('âš ï¸ ç³»çµ±ç‹€æ…‹ç•°å¸¸', 'error');
            }
            
            // ç§»é™¤è‡ªå‹•éš±è—ï¼Œè®“ JSON çµæœä¿æŒé¡¯ç¤º
            // setTimeout(() => this.hideStatus(), 5000);
            
        } catch (error) {
            this.showStatus(`âŒ ${error.message}`, 'error');
        }
    }

    async loadCourseData() {
        try {
            localStorage.removeItem('alarms');

            // this.showStatus('ğŸ”„ Loading...', 'loading');
            
            // ä½¿ç”¨ Google Apps Script çš„ç‰¹æ®Šæ–¹å¼å‘¼å« API
            const data = await this.callGoogleAppsScriptAPI('course');
            
            this.updateAlarmData(data);

            // this.showStatus('âœ…', 'success');
            
            // setTimeout(() => this.hideStatus(), 3000);

            
        } catch (error) {
            this.showStatus(`âŒ ${error.message}`, 'error');
        }
    }

    updateAlarmData(data) {
        syncAlarm(data);
        sortAlarms();
        renderAlarms();
    }
}

// åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
document.addEventListener('DOMContentLoaded', () => {
    // new BellSchedulerUI();
    const bellApp = new BellSchedulerUI();
    bellApp.checkSystemStatus();
    const keepAliveInterval = localStorage.getItem('keepAliveInterval') || 0.5;
    console.log(keepAliveInterval)

    // é€£ç·šæª¢æŸ¥å™¨
    setInterval(() => {
        bellApp.checkSystemStatus();
    }, keepAliveInterval*60000);

});

function getTodayDateFormatted() {
  const today = new Date();

  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0'); // æœˆä»½å¾ 0 é–‹å§‹
  const day = String(today.getDate()).padStart(2, '0');

  return `${year}-${month}-${day}`;
}

renderAlarms();

</script>

</body>
</html>
